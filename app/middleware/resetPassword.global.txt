export default defineNuxtRouteMiddleware(async (to) => {
  const { user, loggedIn } = useUserSession()

  // Skip if not logged in
  if (!loggedIn.value || !user.value) {
    return
  }

  if (to.path === '/auth/reset-password') {
    return
  }
  if (user.value.tempPasswordExpiry && !user.value.tempPasswordUsed) {
    try {
      const expiryDate = new Date(user.value.tempPasswordExpiry)
      const now = new Date()

      if (expiryDate > now) {
        console.log('User needs to reset temporary password')
        return navigateTo('/auth/reset-password')
      }
    }
    catch (error) {
      console.error('Error checking temp password expiry:', error)
    }
  }
})
